<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸Šå¸æ¨¡æ‹Ÿå™¨ â€” God Simulator</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* â”€â”€ Theme Variables â”€â”€ */
:root{
  --bg:#0d1117;--surface:#161b22;--border:#30363d;--text:#e6edf3;
  --muted:#8b949e;--accent:#58a6ff;--green:#3fb950;--red:#f85149;
  --yellow:#d29922;--card-bg:#161b22;--overlay:rgba(0,0,0,.55);
  --footer-text:#8b949e;
  --font-mono:'SF Mono','Cascadia Code','Fira Code','Consolas',monospace;
}
[data-theme="light"]{
  --bg:#f0f2f5;--surface:#ffffff;--border:#d0d7de;--text:#1f2328;
  --muted:#656d76;--accent:#0969da;--green:#1a7f37;--red:#cf222e;
  --yellow:#9a6700;--card-bg:#ffffff;--overlay:rgba(0,0,0,.35);
  --footer-text:#656d76;
}

html,body{height:100%;font-family:var(--font-mono);background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}

/* â”€â”€ App layout â”€â”€ */
#app{display:flex;flex-direction:column;min-height:100vh;max-width:1200px;margin:0 auto;padding:0 16px}

/* â”€â”€ Top bar â”€â”€ */
.top-bar{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.top-bar h1{font-size:20px;font-weight:600;color:var(--accent);letter-spacing:2px;flex:1;text-align:center}
.top-bar h1 span{color:var(--muted);font-weight:400;font-size:13px}
.top-bar-actions{display:flex;gap:6px;position:absolute;right:16px}
.icon-btn{background:var(--surface);border:1px solid var(--border);border-radius:8px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--text);transition:background .2s,border-color .2s}
.icon-btn:hover{border-color:var(--accent);background:var(--accent);color:#fff}

/* â”€â”€ Main content â”€â”€ */
.main-content{flex:1;display:flex;flex-direction:column;gap:16px;padding:8px 0}

/* â”€â”€ Section title â”€â”€ */
.section-title{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;padding-bottom:4px;border-bottom:1px solid var(--border)}

/* â”€â”€ Collapsible categories â”€â”€ */
details.category{margin-bottom:4px}
details.category>summary{cursor:pointer;font-size:14px;font-weight:600;color:var(--accent);padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;list-style:none;display:flex;align-items:center;gap:8px;user-select:none;transition:background .2s}
details.category>summary::-webkit-details-marker{display:none}
details.category>summary::before{content:'â–¶';font-size:10px;transition:transform .2s;display:inline-block}
details.category[open]>summary::before{transform:rotate(90deg)}
details.category>summary:hover{background:var(--accent);color:#fff}
details.category .grid{padding:10px 0 6px}

/* â”€â”€ Status Grid â”€â”€ */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:16px;text-align:center;transition:transform .15s,box-shadow .3s,background .4s}
.card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
.card .key{font-size:11px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.card .value{font-size:26px;font-weight:700;color:var(--text)}
.card.flash-up{animation:flashUp .6s ease}
.card.flash-down{animation:flashDown .6s ease}
.card.flash-new{animation:flashNew .8s ease}
@keyframes flashUp{0%{background:rgba(63,185,80,.35)}100%{background:var(--card-bg)}}
@keyframes flashDown{0%{background:rgba(248,81,73,.35)}100%{background:var(--card-bg)}}
@keyframes flashNew{0%{background:rgba(210,153,34,.5);transform:scale(1.05)}100%{background:var(--card-bg);transform:scale(1)}}

/* â”€â”€ Debug Log â”€â”€ */
.debug{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 18px}
.debug pre{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:12px;max-height:200px;overflow-y:auto;font-size:12px;color:var(--green);white-space:pre-wrap;word-break:break-all}

/* â”€â”€ Controls â”€â”€ */
.controls{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px 18px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.controls .countdown{font-size:13px;color:var(--muted);min-width:200px}
.controls .countdown strong{color:var(--yellow);font-size:16px}
.controls button{background:var(--accent);color:#fff;border:none;border-radius:4px;padding:7px 16px;font-family:var(--font-mono);font-size:13px;cursor:pointer;transition:opacity .2s}
.controls button:hover{opacity:.85}
.controls button.pause{background:var(--yellow);color:#1f2328}
.controls button.danger{background:var(--red)}
.controls input[type="text"]{flex:1;min-width:200px;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 10px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none}
.controls input[type="text"]:focus{border-color:var(--accent)}

.status-bar{font-size:12px;color:var(--muted);text-align:center}
.status-bar.error{color:var(--red)}

/* â”€â”€ Modal overlay â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:var(--overlay);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-overlay.active{opacity:1;pointer-events:auto}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px 24px;width:92%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.4);transform:translateY(20px);transition:transform .25s}
.modal-overlay.active .modal{transform:translateY(0)}
.modal h2{font-size:18px;color:var(--accent);margin-bottom:18px;display:flex;align-items:center;gap:8px}
.modal label{display:flex;flex-direction:column;gap:4px;font-size:12px;color:var(--muted);margin-bottom:14px}
.modal input[type="text"],.modal input[type="password"],.modal input[type="number"]{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px 12px;color:var(--text);font-family:var(--font-mono);font-size:13px;outline:none;width:100%;transition:border-color .2s}
.modal input:focus{border-color:var(--accent)}
.modal .range-row{display:flex;align-items:center;gap:10px}
.modal input[type="range"]{flex:1;accent-color:var(--accent)}
.modal .range-val{font-size:14px;font-weight:700;color:var(--text);min-width:32px;text-align:center}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
.modal-actions button{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:9px 22px;font-family:var(--font-mono);font-size:13px;cursor:pointer;transition:opacity .2s}
.modal-actions button:hover{opacity:.85}

/* â”€â”€ Footer â”€â”€ */
footer{text-align:center;padding:18px 0 14px;font-size:12px;color:var(--footer-text);border-top:1px solid var(--border);margin-top:auto}
footer a{color:var(--accent);text-decoration:none;transition:opacity .2s}
footer a:hover{opacity:.7}
footer .gh-icon{display:inline-block;vertical-align:middle;margin-right:4px}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:768px){
  .top-bar h1{font-size:16px}
  .top-bar h1 span{display:block;font-size:11px}
  .grid{grid-template-columns:1fr}
  .card{padding:20px}
  .card .value{font-size:30px}
  .controls{flex-direction:column;align-items:stretch}
  .controls .countdown{min-width:auto;text-align:center}
  .controls input[type="text"]{min-width:auto}
  .modal{width:96%;padding:22px 18px}
}
</style>
</head>
<body>
<div id="app">
  <!-- Top bar -->
  <div class="top-bar" style="position:relative">
    <h1>ğŸŒ ä¸Šå¸æ¨¡æ‹Ÿå™¨ <span>God Simulator</span></h1>
    <div class="top-bar-actions">
      <button class="icon-btn" id="btnTheme" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
      <button class="icon-btn" id="btnSettings" title="è®¾ç½®">âš™ï¸</button>
    </div>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <!-- State Grid (dynamic categories) -->
    <div class="section-title">ğŸ“Š ä¸–ç•ŒçŠ¶æ€ç›‘æ§</div>
    <div id="stateGrid"></div>

    <!-- Debug Log -->
    <div class="debug">
      <div class="section-title">ğŸ–¥ Raw JSON ç›‘æ§æ—¥å¿—</div>
      <pre id="debugLog">ç­‰å¾…ç¬¬ä¸€æ¬¡æ•°æ®â€¦</pre>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="countdown">è·ç¦»ä¸‹æ¬¡åˆ·æ–°è¿˜å‰© <strong id="cdDisplay">-</strong> ç§’</div>
      <button id="btnPause" class="pause">â¸ æš‚åœ</button>
      <input id="oracleInput" type="text" placeholder="è¾“å…¥ä½ çš„ç¥è°•â€¦">
      <button id="btnOracle">âš¡ å‘é€ç¥è°•</button>
    </div>

    <div class="status-bar" id="statusBar">å°±ç»ª</div>
  </div>

  <!-- Footer -->
  <footer>
    æœ¬é¡¹ç›®é‡‡ç”¨ GPL-3.0 License å¼€æº &copy; 2026 HaveCake &nbsp;|&nbsp;
    <a href="https://github.com/HaveCake/worldbox" target="_blank" rel="noopener noreferrer">
      <svg class="gh-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
      GitHub
    </a>
  </footer>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2>âš™ï¸ è®¾ç½®</h2>
    <label>API Base URL
      <input id="cfgUrl" type="text" placeholder="https://api.openai.comï¼ˆæœªå¡«å†™åˆ™ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤é…ç½®ï¼Œå¦‚å·²é…ç½®ï¼‰">
    </label>
    <label>API Key
      <input id="cfgKey" type="password" placeholder="sk-...ï¼ˆæœªå¡«å†™åˆ™ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤é…ç½®ï¼Œå¦‚å·²é…ç½®ï¼‰">
    </label>
    <label>Model
      <input id="cfgModel" type="text" placeholder="gpt-4oï¼ˆæœªå¡«å†™åˆ™ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤é…ç½®ï¼Œå¦‚å·²é…ç½®ï¼‰">
    </label>
    <label>AI åˆ›é€ åŠ› (Temperature)
      <div class="range-row">
        <input id="cfgTemp" type="range" min="0" max="2" step="0.1" value="1.2">
        <span class="range-val" id="tempDisplay">1.2</span>
      </div>
    </label>
    <label>Tick é—´éš”ï¼ˆç§’ï¼‰
      <input id="cfgTick" type="number" min="1" value="10">
    </label>
    <div class="modal-actions">
      <button id="btnSaveSettings">ğŸ’¾ ä¿å­˜å¹¶å…³é—­</button>
    </div>
  </div>
</div>

<script>
(function () {
  "use strict";

  /* â”€â”€ DOM refs â”€â”€ */
  const cfgUrl     = document.getElementById("cfgUrl");
  const cfgKey     = document.getElementById("cfgKey");
  const cfgModel   = document.getElementById("cfgModel");
  const cfgTick    = document.getElementById("cfgTick");
  const cfgTemp    = document.getElementById("cfgTemp");
  const tempDisplay= document.getElementById("tempDisplay");
  const grid       = document.getElementById("stateGrid");
  const debugLog   = document.getElementById("debugLog");
  const cdDisplay  = document.getElementById("cdDisplay");
  const btnPause   = document.getElementById("btnPause");
  const oracleIn   = document.getElementById("oracleInput");
  const btnOracle  = document.getElementById("btnOracle");
  const statusBar  = document.getElementById("statusBar");
  const btnSettings= document.getElementById("btnSettings");
  const btnSave    = document.getElementById("btnSaveSettings");
  const modalOverlay= document.getElementById("modalOverlay");
  const btnTheme   = document.getElementById("btnTheme");

  /* â”€â”€ State â”€â”€ */
  const INITIAL_STATE = {
    "è‡ªç„¶ç”Ÿæ€": { "æ ‘æœ¨": 125, "ç¯å¢ƒè´¨é‡": 100 },
    "äººç±»ç¤¾ä¼š": { "äººå£": 50 }
  };
  let currentState = JSON.parse(JSON.stringify(INITIAL_STATE));
  let previousState = {};
  let paused = false;
  let countdown = 0;
  let tickTimer = null;
  let requesting = false;

  /* â”€â”€ Theme â”€â”€ */
  function applyTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    btnTheme.textContent = theme === "dark" ? "ğŸŒ™" : "â˜€ï¸";
    localStorage.setItem("worldbox_theme", theme);
  }

  btnTheme.addEventListener("click", () => {
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
  });

  (function initTheme() {
    const saved = localStorage.getItem("worldbox_theme");
    applyTheme(saved || "dark");
  })();

  /* â”€â”€ Settings modal â”€â”€ */
  btnSettings.addEventListener("click", () => modalOverlay.classList.add("active"));
  btnSave.addEventListener("click", () => {
    saveConfig();
    modalOverlay.classList.remove("active");
  });
  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) {
      saveConfig();
      modalOverlay.classList.remove("active");
    }
  });

  cfgTemp.addEventListener("input", () => {
    tempDisplay.textContent = cfgTemp.value;
  });

  /* â”€â”€ localStorage helpers â”€â”€ */
  function saveConfig() {
    const cfg = {
      apiUrl: cfgUrl.value,
      apiKey: cfgKey.value,
      model: cfgModel.value,
      tick: cfgTick.value,
      temperature: cfgTemp.value
    };
    localStorage.setItem("worldbox_cfg", JSON.stringify(cfg));
  }

  function loadConfig() {
    try {
      const cfg = JSON.parse(localStorage.getItem("worldbox_cfg"));
      if (cfg) {
        cfgUrl.value   = cfg.apiUrl  || "";
        cfgKey.value   = cfg.apiKey  || "";
        cfgModel.value = cfg.model   || "";
        cfgTick.value  = cfg.tick    || 10;
        cfgTemp.value  = cfg.temperature !== undefined ? cfg.temperature : 1.2;
        tempDisplay.textContent = cfgTemp.value;
      }
    } catch (e) { console.warn("loadConfig:", e); }
  }

  /* â”€â”€ Render grid (nested / flat compatible) â”€â”€ */
  function isNestedState(state) {
    return Object.values(state).some(v => typeof v === "object" && v !== null && !Array.isArray(v));
  }

  function renderState() {
    grid.innerHTML = "";
    if (isNestedState(currentState)) {
      renderNestedState();
    } else {
      renderFlatState();
    }
  }

  function renderNestedState() {
    const categories = Object.keys(currentState);
    categories.forEach(cat => {
      const val = currentState[cat];
      if (typeof val === "object" && val !== null && !Array.isArray(val)) {
        const details = document.createElement("details");
        details.className = "category";
        details.open = true;
        const summary = document.createElement("summary");
        summary.textContent = cat;
        details.appendChild(summary);

        const subGrid = document.createElement("div");
        subGrid.className = "grid";
        const prevCat = (previousState && typeof previousState[cat] === "object") ? previousState[cat] : {};

        Object.keys(val).forEach(key => {
          const card = createCard(key, val[key], prevCat[key]);
          subGrid.appendChild(card);
        });

        details.appendChild(subGrid);
        grid.appendChild(details);
      } else {
        const card = createCard(cat, val, previousState ? previousState[cat] : undefined);
        grid.appendChild(card);
      }
    });
  }

  function renderFlatState() {
    const wrap = document.createElement("div");
    wrap.className = "grid";
    Object.keys(currentState).forEach(key => {
      const card = createCard(key, currentState[key], previousState ? previousState[key] : undefined);
      wrap.appendChild(card);
    });
    grid.appendChild(wrap);
  }

  function createCard(key, val, oldVal) {
    const card = document.createElement("div");
    card.className = "card";
    if (oldVal === undefined) {
      card.classList.add("flash-new");
    } else if (typeof val === "number" && typeof oldVal === "number") {
      if (val > oldVal) card.classList.add("flash-up");
      else if (val < oldVal) card.classList.add("flash-down");
    }
    card.innerHTML =
      '<div class="key">' + escapeHtml(String(key)) + '</div>' +
      '<div class="value">' + escapeHtml(String(val)) + '</div>';
    return card;
  }

  function escapeHtml(s) {
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  /* â”€â”€ Debug log â”€â”€ */
  function appendDebugLog(json) {
    const ts = new Date().toLocaleTimeString();
    const entry = "[" + ts + "]\n" + JSON.stringify(json, null, 2) + "\n\n";
    debugLog.textContent = entry + debugLog.textContent;
  }

  /* â”€â”€ Defensive JSON extraction â”€â”€ */
  function extractJSON(text) {
    try { return JSON.parse(text); } catch (_) { /* fall through */ }
    const fenced = /```json([\s\S]*?)```/.exec(text);
    if (fenced) return JSON.parse(fenced[1].trim());
    const braces = /\{[\s\S]*\}/.exec(text);
    if (braces) return JSON.parse(braces[0]);
    throw new Error("Cannot extract JSON");
  }

  /* â”€â”€ API call (slice-only: system + current state + new concepts) â”€â”€ */
  async function callEvolve(userPrompt) {
    const apiUrl = cfgUrl.value.trim();
    const apiKey = cfgKey.value.trim();
    const model  = cfgModel.value.trim();
    const temperature = parseFloat(cfgTemp.value);

    requesting = true;
    setStatus("ğŸ”„ æ­£åœ¨è¯·æ±‚ LLMâ€¦");

    const backendUrl = (location.origin.includes("file://") ? "http://localhost:3000" : location.origin) + "/evolve";

    try {
      const resp = await fetch(backendUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          apiUrl,
          apiKey,
          model,
          temperature,
          current_state: currentState,
          user_prompt: userPrompt || ""
        })
      });

      let data;
      const raw = await resp.text();
      try {
        data = extractJSON(raw);
      } catch {
        appendDebugLog({ raw_response: raw });
        setStatus("âŒ å“åº”è§£æå¤±è´¥", true);
        return false;
      }

      appendDebugLog(data);

      if (!resp.ok) {
        setStatus("âŒ åç«¯é”™è¯¯: " + (data.error || resp.statusText), true);
        return false;
      }

      previousState = JSON.parse(JSON.stringify(currentState));
      currentState = data;
      renderState();
      setStatus("âœ… ä¸–ç•Œå·²æ¼”å˜ â€” " + new Date().toLocaleTimeString());
      return true;
    } catch (err) {
      appendDebugLog({ error: err.message });
      setStatus("âŒ ç½‘ç»œé”™è¯¯: " + err.message, true);
      return false;
    } finally {
      requesting = false;
    }
  }

  /* â”€â”€ Status bar â”€â”€ */
  function setStatus(msg, isError) {
    statusBar.textContent = msg;
    statusBar.className = "status-bar" + (isError ? " error" : "");
  }

  /* â”€â”€ Timer / countdown â”€â”€ */
  function getTickSeconds() {
    const v = parseInt(cfgTick.value, 10);
    return (v && v > 0) ? v : 10;
  }

  function startCountdown() {
    stopCountdown();
    countdown = getTickSeconds();
    cdDisplay.textContent = countdown;
    tickTimer = setInterval(() => {
      if (paused || requesting) return;
      countdown--;
      cdDisplay.textContent = Math.max(countdown, 0);
      if (countdown <= 0) {
        stopCountdown();
        callEvolve("").then(() => startCountdown());
      }
    }, 1000);
  }

  function stopCountdown() {
    if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
  }

  /* â”€â”€ Pause / resume â”€â”€ */
  btnPause.addEventListener("click", () => {
    paused = !paused;
    btnPause.textContent = paused ? "â–¶ ç»§ç»­" : "â¸ æš‚åœ";
    btnPause.className = paused ? "pause danger" : "pause";
  });

  /* â”€â”€ Send oracle â”€â”€ */
  btnOracle.addEventListener("click", async () => {
    const text = oracleIn.value.trim();
    if (!text) return;
    oracleIn.value = "";
    stopCountdown();
    await callEvolve(text);
    startCountdown();
  });

  oracleIn.addEventListener("keydown", (e) => {
    if (e.key === "Enter") btnOracle.click();
  });

  /* â”€â”€ Init â”€â”€ */
  loadConfig();
  previousState = {};
  renderState();
  startCountdown();
})();
</script>
</body>
</html>
